rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // FUNCTION: Check if user is Admin
    function isAdmin() {
      // NOTE: We trust the 'role' field in the user's main profile.
      // A more robust system would use Custom Claims, but for this architecture,
      // we check the 'profile/main' document of the requestor.
      // CAUTION: This requires the profile to be readable by the user themselves!
      let profile = get(/databases/$(database)/documents/users/$(request.auth.uid)/profile/main);
      return profile.data.role == 'ADMIN';
    }

    // FUNCTION: Check ownership
    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    // --- COLLECTION GROUP QUERIES (Admin Only) ---
    // Admins need to query ALL 'profile' and 'sessions' docs across the system.
    match /{path=**}/profile/{docId} {
      allow read: if isAdmin();
    }
    match /{path=**}/sessions/{docId} {
      allow read: if isAdmin();
    }

    // --- USER DATA (Owner or Admin) ---
    match /users/{uid} {
      // Allow user to read/write their own root? (Not used much, but safe)
      allow read, write: if isOwner(uid) || isAdmin();

      // Profile Subcollection
      match /profile/{docId} {
        allow read: if isOwner(uid) || isAdmin();
        allow write: if isOwner(uid) || isAdmin();
      }

      // Subject/Lecture/Session Hierarchy
      match /subjects/{subjectId} {
        allow read, write: if isOwner(uid) || isAdmin();
        
        match /lectures/{lectureId} {
          allow read, write: if isOwner(uid) || isAdmin();

          match /sessions/{sessionId} {
            allow read, write: if isOwner(uid) || isAdmin();
          }
        }
      }

      // State Snapshot & Cognitive Index
      match /stateSnapshot/{docId} {
        allow read, write: if isOwner(uid) || isAdmin();
      }
      match /cognitiveIndex/{docId} {
        allow read, write: if isOwner(uid) || isAdmin();
      }
    }
  }
}
